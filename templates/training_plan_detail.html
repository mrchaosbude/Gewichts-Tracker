{% extends "base.html" %}

{% block title %}{{ training_plan.title }}{% endblock %}

{% block extra_head %}
  <style>
    .session-list {
      font-size: 0.9rem;
    }

    .exercise-stats-toggle {
      margin-bottom: 1rem;
    }

    .exercise-stats-toggle summary {
      display: block;
      cursor: pointer;
      padding: 0.75rem 1.25rem;
      margin-bottom: 0;
      color: #495057;
      background-color: #fff;
      border: 1px solid #6c757d;
      border-radius: 0.25rem;
      font-weight: 600;
      list-style: none;
      position: relative;
    }

    .exercise-stats-toggle summary::-webkit-details-marker {
      display: none;
    }

    .exercise-stats-toggle summary::after {
      content: '\25bc';
      position: absolute;
      right: 1rem;
      transition: transform 0.2s ease;
    }

    .exercise-stats-toggle[open] summary::after {
      transform: rotate(180deg);
    }

    .exercise-stats-toggle summary:focus {
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
    }

    .exercise-stats-toggle[open] summary {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }

    .exercise-stats-body {
      border: 1px solid #6c757d;
      border-top: none;
      border-bottom-left-radius: 0.25rem;
      border-bottom-right-radius: 0.25rem;
      padding: 1rem;
      background-color: #fff;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">{{ training_plan.title }}</h2>
      <form action="{{ url_for('delete_training_plan', training_plan_id=training_plan.id) }}" method="POST" onsubmit="return confirm('Trainingsplan wirklich löschen?');">
        {{ delete_plan_form.hidden_tag() }}
        {{ delete_plan_form.submit(class="btn btn-danger btn-sm") }}
      </form>
    </div>
    <p>{{ training_plan.description }}</p>
    <a href="{{ url_for('add_exercise_to_plan', training_plan_id=training_plan.id) }}" class="btn btn-success mb-3 btn-block">Übung hinzufügen</a>
    {% if exercise_overview %}
      <details id="exerciseStatsToggle" class="exercise-stats-toggle">
        <summary>Übungsstatistiken</summary>
        <div class="exercise-stats-body">
          <div class="table-responsive mb-4">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Übung</th>
                  <th class="text-center">Sätze</th>
                  <th>Letzte Einheit</th>
                  <th>Gesamtvolumen</th>
                  <th>Max. Gewicht</th>
                  <th>Beste 1RM (Epley)</th>
                  <th>Ø Volumen ({{ exercise_overview[0].moving_window }}er Ø)</th>
                </tr>
              </thead>
              <tbody>
                {% for item in exercise_overview %}
                  {% set summary = item.summary %}
                  {% set personal_bests = item.personal_bests %}
                  <tr>
                    <td>
                      <strong>{{ item.exercise.name }}</strong>
                      {% if item.exercise.description %}
                        <div class="small text-muted">{{ item.exercise.description }}</div>
                      {% endif %}
                    </td>
                    <td class="text-center">{{ summary.total_sessions }}</td>
                    <td>
                      {% if summary.latest_session %}
                        {{ summary.latest_session.timestamp.strftime('%d.%m.%Y') }}<br>
                        <span class="small text-muted">{{ summary.latest_session.weight }} kg × {{ summary.latest_session.repetitions }}</span>
                      {% else %}
                        <span class="text-muted">–</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if summary.total_sessions %}
                        {{ summary.total_volume|round(1) }} kg
                      {% else %}
                        <span class="text-muted">–</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if personal_bests.max_weight %}
                        {{ personal_bests.max_weight.value }} kg
                        <div class="small text-muted">{{ personal_bests.max_weight.repetitions }} Wdh</div>
                      {% else %}
                        <span class="text-muted">–</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if personal_bests.max_one_rm %}
                        {{ personal_bests.max_one_rm.value|round(1) }} kg
                        <div class="small text-muted">{{ personal_bests.max_one_rm.weight }} kg × {{ personal_bests.max_one_rm.repetitions }}</div>
                      {% else %}
                        <span class="text-muted">–</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if summary.total_sessions %}
                        {{ summary.recent_volume_average|round(1) }} kg
                      {% else %}
                        <span class="text-muted">–</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </details>
      <h3>Übungen</h3>
      <ul class="list-group">
        {% for item in exercise_overview %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between">
              <div class="pr-3">
                <strong>{{ item.exercise.name }}</strong>
                {% if item.exercise.description %}
                  <p class="mb-2 small text-muted">{{ item.exercise.description }}</p>
                {% endif %}
                <div class="session-list">
                  {% for session in item.recent_sessions %}
                    <div>
                      {{ session.timestamp.strftime('%d.%m.%Y %H:%M') }} - {{ session.weight }} kg - {{ session.repetitions }} Wiederholungen
                    </div>
                  {% else %}
                    <div class="text-muted">Noch keine Einheiten erfasst.</div>
                  {% endfor %}
                </div>
              </div>
              <div class="d-flex align-items-start">
                <a href="{{ url_for('exercise_detail', exercise_id=item.exercise.id) }}" class="btn btn-info btn-sm">Details</a>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="alert alert-info">Füge deinem Trainingsplan eine Übung hinzu, um Auswertungen zu sehen.</div>
    {% endif %}
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-block mt-3">Zurück</a>
  </div>
{% endblock %}

